// ===== Firebase Setup =====
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { 
  getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword,
  sendPasswordResetEmail, onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { 
  getFirestore, doc, getDoc, setDoc 
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// ===== Your Firebase Config =====
const firebaseConfig = {
  // paste your config here
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const body = document.body;

// ===== Theme Handling =====
function applyTheme(theme) {
  body.classList.remove("theme-pink", "theme-blue", "theme-dark", "theme-lavender");
  if (theme) body.classList.add(theme);
}

// Load theme from Firestore
async function loadTheme(user) {
  if (!user) return;
  const userRef = doc(db, "users", user.uid);
  const snap = await getDoc(userRef);
  if (snap.exists()) {
    const data = snap.data();
    if (data.theme) {
      applyTheme(data.theme);
      localStorage.setItem("lastTheme", data.theme); // save for next time
    }
  }
}

// Fallback: Apply last theme immediately from localStorage
const lastTheme = localStorage.getItem("lastTheme");
if (lastTheme) applyTheme(lastTheme);

// Sync when user is logged in
onAuthStateChanged(auth, async (user) => {
  if (user) {
    await loadTheme(user);
  }
});

// ===== Auth Forms =====
const loginForm = document.getElementById("loginForm");
const signupForm = document.getElementById("signupForm");
const forgotForm = document.getElementById("forgotForm");

const showSignup = document.getElementById("showSignup");
const showForgot = document.getElementById("showForgot");

// --- Login ---
if (loginForm) {
  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    try {
      await signInWithEmailAndPassword(auth, email, password);
      window.location.href = "profile.html"; // redirect after login
    } catch (error) {
      alert("Login failed: " + error.message);
    }
  });
}

// --- Signup ---
if (signupForm) {
  signupForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = document.getElementById("signupEmail").value;
    const password = document.getElementById("signupPassword").value;
    try {
      const userCred = await createUserWithEmailAndPassword(auth, email, password);
      const user = userCred.user;
      // create initial user doc with default theme
      await setDoc(doc(db, "users", user.uid), {
        theme: "theme-pink" // default theme
      });
      window.location.href = "profile.html";
    } catch (error) {
      alert("Signup failed: " + error.message);
    }
  });
}

// --- Forgot Password ---
if (forgotForm) {
  forgotForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = document.getElementById("forgotEmail").value;
    try {
      await sendPasswordResetEmail(auth, email);
      alert("Password reset link sent!");
    } catch (error) {
      alert("Error: " + error.message);
    }
  });
}

// ===== Toggle Forms =====
if (showSignup) {
  showSignup.addEventListener("click", (e) => {
    e.preventDefault();
    loginForm.style.display = "none";
    signupForm.style.display = "block";
    forgotForm.style.display = "none";
  });
}

if (showForgot) {
  showForgot.addEventListener("click", (e) => {
    e.preventDefault();
    loginForm.style.display = "none";
    signupForm.style.display = "none";
    forgotForm.style.display = "block";
  });
}
